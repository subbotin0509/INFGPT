<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-primary: #007bff;
            --accent-success: #28a745;
            --accent-danger: #dc3545;
            --accent-warning: #ffc107;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #adb5bd;
            --border-color: #495057;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .analytics-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .analytics-header {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .analytics-content {
            padding: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-primary);
        }

        .stat-card.success { border-left-color: var(--accent-success); }
        .stat-card.warning { border-left-color: var(--accent-warning); }
        .stat-card.danger { border-left-color: var(--accent-danger); }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .stat-card.success .stat-number { color: var(--accent-success); }
        .stat-card.warning .stat-number { color: var(--accent-warning); }
        .stat-card.danger .stat-number { color: var(--accent-danger); }

        .chart-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            height: 250px;
        }

        .quality-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .quality-excellent { background: #28a745; }
        .quality-good { background: #20c997; }
        .quality-fair { background: #ffc107; color: black; }
        .quality-poor { background: #dc3545; }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
    </style>
</head>
<body>
    <div class="analytics-container">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="analytics-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4><i class="fas fa-chart-line me-2"></i>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h4>
                    <p class="text-muted mb-0">–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</p>
                </div>
                <div>
                    <a href="/admin" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-arrow-left me-2"></i>–ù–∞–∑–∞–¥
                    </a>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="analytics-content">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="totalQuestions">0</div>
                        <div class="text-muted">–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card success">
                        <div class="stat-number" id="successRate">0%</div>
                        <div class="text-muted">–£—Å–ø–µ—à–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card warning">
                        <div class="stat-number" id="satisfactionRate">0%</div>
                        <div class="text-muted">–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="avgResponseTime">0—Å</div>
                        <div class="text-muted">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</div>
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6>–ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤</h6>
                        <canvas id="qualityChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6>–û—Ü–µ–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h6>
                        <canvas id="feedbackChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–æ–ø—Ä–æ—Å—ã -->
            <div class="row">
                <div class="col-12">
                    <div class="stat-card">
                        <h6>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–æ–ø—Ä–æ—Å—ã</h6>
                        <div id="recentQuestions" class="mt-3">
                            <div class="loading-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let qualityChart, feedbackChart;

        async function refreshAnalytics() {
            try {
                showLoadingStates();
                
                const response = await fetch('/admin/analytics_data');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                updateDashboard(data);
                updateCharts(data);
                updateRecentQuestions(data.recent_questions);
                
            } catch (error) {
                console.error('Error fetching analytics:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏');
            }
        }

        function showLoadingStates() {
            document.getElementById('recentQuestions').innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>`;
        }

        function showError(message) {
            document.getElementById('recentQuestions').innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>${message}
                </div>`;
        }

        function updateDashboard(data) {
            document.getElementById('totalQuestions').textContent = data.total_questions.toLocaleString();
            document.getElementById('successRate').textContent = data.success_rate + '%';
            document.getElementById('satisfactionRate').textContent = data.satisfaction_rate + '%';
            document.getElementById('avgResponseTime').textContent = data.avg_response_time + '—Å';
        }

        function updateCharts(data) {
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
            const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary');

            // –ì—Ä–∞—Ñ–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤
            if (qualityChart) qualityChart.destroy();
            const qualityCtx = document.getElementById('qualityChart').getContext('2d');
            qualityChart = new Chart(qualityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['–û—Ç–ª–∏—á–Ω—ã–µ', '–•–æ—Ä–æ—à–∏–µ', '–£–¥–æ–≤–ª–µ—Ç.', '–ü–ª–æ—Ö–∏–µ'],
                    datasets: [{
                        data: data.quality_distribution,
                        backgroundColor: ['#28a745', '#20c997', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor }
                        }
                    }
                }
            });

            // –ì—Ä–∞—Ñ–∏–∫ –æ—Ü–µ–Ω–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (feedbackChart) feedbackChart.destroy();
            const feedbackCtx = document.getElementById('feedbackChart').getContext('2d');
            feedbackChart = new Chart(feedbackCtx, {
                type: 'pie',
                data: {
                    labels: ['–õ–∞–π–∫–∏', '–î–∏–∑–ª–∞–π–∫–∏'],
                    datasets: [{
                        data: [data.user_likes, data.user_dislikes],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor }
                        }
                    }
                }
            });
        }

        function updateRecentQuestions(questions) {
            const container = document.getElementById('recentQuestions');
            
            if (!questions || questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤–æ–ø—Ä–æ—Å–∞—Ö</p>
                    </div>`;
                return;
            }

            container.innerHTML = questions.map(q => `
                <div class="border-bottom pb-2 mb-2">
                    <div class="small">${q.question}</div>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <span class="quality-badge quality-${q.quality}">${q.quality_text}</span>
                        <small class="text-muted">${q.timestamp}</small>
                    </div>
                </div>
            `).join('');
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            refreshAnalytics();
        });
    </script>
</body>
</html>